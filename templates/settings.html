<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - WatchGuard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="/static/nav-animations.js"></script>
</head>
<body class="bg-gradient settings-page">
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <h1 class="loading-title">WatchGuard</h1>
            <div class="loading-progress">
                <div class="loading-progress-bar"></div>
            </div>
        </div>
    </div>

    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-left">
                <a href="/" class="nav-logo">WatchGuard</a>
                <div class="nav-breadcrumb">
                    <a href="/">Home</a>
                    <span class="nav-breadcrumb-separator">></span>
                    <span>Settings</span>
                </div>
            </div>
            <div class="nav-menu">
                <button class="nav-menu-toggle" onclick="toggleNavMenu()">
                    <div class="hamburger">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </button>
                <div class="nav-dropdown" id="navDropdown">
                    <a href="/">
                        <span>
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" aria-hidden="true">
                                <path d="M3 10.5 12 3l9 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M5 10.5V20h14v-9.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        Dashboard
                    </a>
                    <a href="/servers">
                        <span>
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" aria-hidden="true">
                                <rect x="3" y="4" width="18" height="12" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                                <rect x="9" y="18" width="6" height="2" rx="1" ry="1" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </span>
                        Servers
                    </a>
                    <a href="/domains">
                        <span>
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" aria-hidden="true">
                                <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                <path d="M3 12h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M12 3c2.5 2.7 4 6 4 9s-1.5 6.3-4 9M12 3c-2.5 2.7-4 6-4 9s1.5 6.3 4 9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </span>
                        Domains
                    </a>
                    <a href="/add_server">
                        <span>
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" aria-hidden="true">
                                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </span>
                        Add Server
                    </a>
                    <a href="/add_domain">
                        <span>
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" aria-hidden="true">
                                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </span>
                        Add Domain
                    </a>
                    <a href="/settings">
                        <span>
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" aria-hidden="true">
                                <path d="M12 9m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" stroke="currentColor" stroke-width="2" fill="none"/>
                                <path d="M10.325 4.317l.366-1.366a1 1 0 0 1 1.918 0l.366 1.366a1 1 0 0 0 .668.707l1.4.5a1 1 0 0 1 .5 1.5l-.8 1.2a1 1 0 0 0 0 1.1l.8 1.2a1 1 0 0 1 -.5 1.5l-1.4.5a1 1 0 0 0 -.668.707l-.366 1.366a1 1 0 0 1 -1.918 0l-.366-1.366a1 1 0 0 0 -.668-.707l-1.4-.5a1 1 0 0 1 -.5-1.5l.8-1.2a1 1 0 0 0 0-1.1l-.8-1.2a1 1 0 0 1 .5-1.5l1.4-.5a1 1 0 0 0 .668-.707" stroke="currentColor" stroke-width="2" fill="none"/>
                            </svg>
                        </span>
                        Settings
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>Settings</h1>
        </div>

        <div class="content-grid center-main">
            <div class="main-content">
                <div class="glass-card">
                    <div class="card-header center-header">
                        <div>
                            <h2>Application Settings</h2>
                            <p class="header-description">Configure your watchguard preferences</p>
                        </div>
                    </div>
                    
                    <form id="settingsForm" class="form-container">
                        <div class="form-group">
                            <label for="warning_days">Warning Days *</label>
                            <input type="number" id="warning_days" name="warning_days" class="form-input" 
                                   value="{{ settings.warning_days }}" 
                                   min="1" max="30" required>
                            <small style="color: var(--text-muted); font-size: 0.8rem;">
                                Number of days before expiration to show warnings
                            </small>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="notification_hour">Notification Hour *</label>
                                <select id="notification_hour" name="notification_hour" class="form-select" required>
                                    {% for hour in range(24) %}
                                        <option value="{{ hour }}" 
                                                {% if settings.notification_hour == hour %}selected{% endif %}>
                                            {{ "%02d"|format(hour) }}:00
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="notification_minute">Notification Minute *</label>
                                <select id="notification_minute" name="notification_minute" class="form-select" required>
                                    {% for minute in range(0, 60, 5) %}
                                        <option value="{{ minute }}" 
                                                {% if settings.notification_minute == minute %}selected{% endif %}>
                                            {{ "%02d"|format(minute) }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="daily_notifications">Daily Notifications</label>
                            <select id="daily_notifications" name="daily_notifications" class="form-select">
                                <option value="true" {% if settings.daily_notifications %}selected{% endif %}>
                                    Enabled
                                </option>
                                <option value="false" {% if not settings.daily_notifications %}selected{% endif %}>
                                    Disabled
                                </option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Current Configuration</label>
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--border-radius); border: 1px solid var(--border-color);">
                                <div style="font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-secondary);">
                                    <div>• Warning threshold: {{ settings.warning_days | default(5) }} days</div>
                                    <div>• Notification time: {{ "%02d"|format(settings.notification_hour | default(9)) }}:{{ "%02d"|format(settings.notification_minute | default(0)) }}</div>
                                    <div>• Daily notifications: {{ "Enabled" if settings.daily_notifications else "Disabled" }}</div>
                                    
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="label-management-container">
                                <div class="label-header">
                                    <h3>Label Management</h3>
                                </div>
                                <div class="label-input-row">
                                    <input type="text" id="newLabel" class="form-input" placeholder="Enter new label name" 
                                           onkeypress="if(event.key === 'Enter') addLabel()">
                                    <button type="button" class="glass-button primary" onclick="addLabel()">
                                        <span class="btn-icon">
                                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true">
                                                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                        </span>
                                        Add Label
                                    </button>
                                </div>
                                
                                <div class="labels-list" id="labelsList">
                                    {% if existing_labels %}
                                        <div id="labelsContainer">
                                        </div>
                                        <div class="labels-pagination" id="labelsPagination" style="display: none;">
                                            <button type="button" class="pagination-btn" id="prevPageBtn" onclick="changePage(-1)">
                                                <span>
                                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true">
                                                        <path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                    </svg>
                                                </span>
                                            </button>
                                            <span class="page-info" id="pageInfo">1/1</span>
                                            <button type="button" class="pagination-btn" id="nextPageBtn" onclick="changePage(1)">
                                                <span>
                                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true">
                                                        <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                    </svg>
                                                </span>
                                            </button>
                                        </div>
                                    {% else %}
                                        <div class="no-labels">No labels found</div>
                                    {% endif %}
                                </div>
                                
                                <div class="label-actions">
                                    <button type="button" class="glass-button secondary" onclick="syncLabels()">
                                        <span class="btn-icon">
                                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true">
                                                <path d="M20 12a8 8 0 1 1-2.3-5.7" stroke="currentColor" stroke-width="2" fill="none"/>
                                                <path d="M20 4v4h-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </span>
                                        Sync Labels
                                    </button>
                                    <button type="button" class="glass-button secondary" onclick="refreshLabels()">
                                        <span class="btn-icon">
                                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true">
                                                <path d="M4.5 12a7.5 7.5 0 1 0 2.2-5.3" stroke="currentColor" stroke-width="2" fill="none"/>
                                                <path d="M3 7v4h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </span>
                                        Refresh
                                    </button>
                                </div>
                                <button type="button" class="glass-button primary mobile-add-label" onclick="addLabel()">
                                    <span class="btn-icon">
                                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true">
                                            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </span>
                                    Add Label
                                </button>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="glass-button secondary" onclick="goBack()">
                                <span class="btn-icon">←</span>
                                Cancel
                            </button>
                            <button type="submit" class="glass-button primary">
                                Save Settings
                            </button>
                        </div>
                    </form>
                </div>

                
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <div class="footer-content">
            <span>WatchGuard • {{ APP_VERSION }}</span>
            <br>
            <span style="opacity: 0.85;">Made with ❤️ by AsanFillter</span>
        </div>
    </footer>

    <div id="notification" class="notification hidden"></div>

    <script>
        window.addEventListener('load', function() {
            const loadingScreen = document.getElementById('loadingScreen');
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }, 1000);
        });

        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'A' && e.target.href && !e.target.href.includes('#')) {
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.style.display = 'flex';
                loadingScreen.classList.remove('hidden');
            }
        });

        let currentLabelsPage = 0;
        let labelsPerPage = 8;
        let allLabels = [{% for label in existing_labels %}'{{ label }}'{% if not loop.last %},{% endif %}{% endfor %}];
        
        function renderLabels() {
            const container = document.getElementById('labelsContainer');
            const pagination = document.getElementById('labelsPagination');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');
            
            if (!container) return;
            
            const totalPages = Math.ceil(allLabels.length / labelsPerPage);
            const startIdx = currentLabelsPage * labelsPerPage;
            const endIdx = Math.min(startIdx + labelsPerPage, allLabels.length);
            const currentPageLabels = allLabels.slice(startIdx, endIdx);
            
            container.innerHTML = '';
            currentPageLabels.forEach(label => {
                const labelItem = document.createElement('div');
                labelItem.className = 'label-item';
                labelItem.setAttribute('data-label', label);
                labelItem.innerHTML = `
                    <span class="label-text">${label}</span>
                    <button type="button" class="label-remove-btn" onclick="removeLabel('${label}')" aria-label="Remove label">
                        <span>
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true" focusable="false">
                                <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" stroke="currentColor" stroke-width="2" stroke-linejoin="round" fill="none"/>
                                <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </span>
                    </button>
                `;
                container.appendChild(labelItem);
            });
            
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                pageInfo.textContent = `${currentLabelsPage + 1}/${totalPages}`;
                prevBtn.disabled = currentLabelsPage === 0;
                nextBtn.disabled = currentLabelsPage === totalPages - 1;
            } else {
                pagination.style.display = 'none';
            }
        }
        
        function changePage(direction) {
            const totalPages = Math.ceil(allLabels.length / labelsPerPage);
            const newPage = currentLabelsPage + direction;
            
            if (newPage >= 0 && newPage < totalPages) {
                currentLabelsPage = newPage;
                renderLabels();
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            renderLabels();
        });

        async function addLabel() {
            const input = document.getElementById('newLabel');
            const label = input.value.trim();
            
            if (!label) {
                showNotification('Please enter a label name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/labels/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `label=${encodeURIComponent(label)}`
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification(result.message, 'success');
                    input.value = '';
                    if (!allLabels.includes(label)) {
                        allLabels.push(label);
                        renderLabels();
                    }
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Error adding label', 'error');
            }
        }

        async function removeLabel(label) {
            if (!confirm(`Are you sure you want to remove the label "${label}"? This will remove it from all servers and domains.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/labels/remove', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `label=${encodeURIComponent(label)}`
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification(result.message, 'error');
                    const index = allLabels.indexOf(label);
                    if (index > -1) {
                        allLabels.splice(index, 1);
                        const totalPages = Math.ceil(allLabels.length / labelsPerPage);
                        if (currentLabelsPage >= totalPages && totalPages > 0) {
                            currentLabelsPage = totalPages - 1;
                        }
                        renderLabels();
                    }
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Error removing label', 'error');
            }
        }

        async function syncLabels() {
            try {
                const response = await fetch('/api/labels/sync', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification(result.message, 'success');
                    refreshLabels();
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                showNotification('Error syncing labels', 'error');
            }
        }

        async function refreshLabels() {
            try {
                const response = await fetch('/api/labels');
                const result = await response.json();
                
                if (result.status === 'success') {
                    location.reload();
                }
            } catch (error) {
                showNotification('Error refreshing labels', 'error');
            }
        }

        function goBack() {
            window.location.href = '/';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        function exportData() {
            showNotification('Export feature coming soon!', 'info');
        }

        function clearCache() {
            if (confirm('Are you sure you want to clear the cache?')) {
                showNotification('Cache cleared successfully!', 'success');
            }
        }

        document.getElementById('settingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = 'Saving...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('/save_settings', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification('Settings saved successfully!', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification(result.message || 'Error saving settings', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                showNotification('Network error occurred', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>